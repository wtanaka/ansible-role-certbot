---
- include: compat.yml

- include: include_vars.yml

- include: Debian.yml
  when: ansible_os_family == 'Debian'

- include: RedHat.yml
  when: ansible_os_family == 'RedHat'

- include: install_package_names.yml

# Avoid running this in integration tests, because it requires that
# a webserver is already alive and can serve files from
# letsencrypt_webroot
- name: run certbot
  sudo: True
  register: certonly_result
  changed_when: >
    not (certonly_result.stdout == '' and certonly_result.stderr == '')
  command: >
    letsencrypt certonly --non-interactive
    --email {{letsencrypt_email}}
    {{letsencrypt_agree_tos}}
    --webroot
    -w {{letsencrypt_webroot}}
    -d {{letsencrypt_domains | join(" -d ")}}
  when: >
    ((is_integration_test is not defined or not is_integration_test) and
    letsencrypt_domains)

- name: renew certificates
  sudo: True
  command: >
    letsencrypt renew --non-interactive
    {{letsencrypt_renew_by_default | default("")}}
    --email {{letsencrypt_email}}
  register: renew_result
  changed_when: >
    'No renewals were attempted' not in renew_result.stdout
  when: >
    ((is_integration_test is not defined or not is_integration_test) and
    letsencrypt_domains)
