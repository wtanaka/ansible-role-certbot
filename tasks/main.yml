---
- include: compat.yml

- include: include_vars.yml

- include: Debian.yml
  when: ansible_os_family == 'Debian'

- include: RedHat.yml
  when: ansible_os_family == 'RedHat'

- include: install_package_names.yml

- name: download certbot-auto
  command: wget -O {{letsencrypt_binary}} https://dl.eff.org/certbot-auto
  args:
    creates: "{{letsencrypt_binary}}"
  when: letsencrypt_use_certbot_auto

- name: download certbot-auto
  file:
    path: "{{letsencrypt_binary}}"
    mode: "0755"
  when: letsencrypt_use_certbot_auto

- name: create directory
  sudo: True
  file: >
    path=/etc/letsencrypt
    state=directory

# for use in integration test environments
- name: copy fake key
  sudo: True
  when: letsencrypt_fake_key is defined and letsencrypt_fake_key
  copy:
    src: server.crt
    dest: /etc/letsencrypt/fake-server.crt

# for use in integration test environments
- name: copy fake key
  sudo: True
  when: letsencrypt_fake_key is defined and letsencrypt_fake_key
  copy:
    src: server.key
    dest: /etc/letsencrypt/fake-server.key

# Avoid running this in integration tests, because it requires that
# a webserver is already alive and can serve files from
# letsencrypt_webroot
- name: run certbot
  sudo: True
  register: certonly_result
  changed_when: >
    not (certonly_result.stdout == '' and certonly_result.stderr == '')
  command: >
    {{letsencrypt_binary}} certonly --non-interactive
    --email {{letsencrypt_email}}
    {{letsencrypt_agree_tos}}
    --webroot
    -w {{letsencrypt_webroot}}
    -d {{letsencrypt_domains | join(" -d ")}}
  when: >
    (letsencrypt_domains and letsencrypt_domains|length > 0 and
      (is_integration_test is not defined or not is_integration_test))

- name: renew certificates
  sudo: True
  command: >
    letsencrypt renew --non-interactive
    {{letsencrypt_renew_by_default | default("")}}
    --email {{letsencrypt_email}}
  register: renew_result
  changed_when: >
    'No renewals were attempted' not in renew_result.stdout
  when: >
    (letsencrypt_domains and letsencrypt_domains|length > 0 and
      (is_integration_test is not defined or not is_integration_test))
